<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nu spelas</title>
<style>
  :root{ --accent:#c84cff; --text:#f6e9f5; --muted:#e9d3f2; --bar-bg:rgba(255,255,255,.16); --radius:18px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#0b0710;display:grid;place-items:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter;color:var(--text)}
  .wrap{width:min(760px,94vw)}

  .card{
    position:relative;width:100%;padding:18px 22px 20px;border-radius:var(--radius);
    overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.45);isolation:isolate;
    cursor:pointer;text-decoration:none;color:inherit;display:block
  }
  .bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(26px) saturate(130%) brightness(70%);transform:scale(1.12);z-index:-2}
  .card::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(18,8,22,.70),rgba(35,10,35,.42));z-index:-1}

  .row{display:flex;align-items:center;gap:18px}
  .cover{width:110px;height:110px;flex:0 0 auto;border-radius:50%;padding:5px;
    background:radial-gradient(closest-side, color-mix(in oklab, var(--accent) 40%, transparent), transparent 68%), var(--accent)}
  .cover img{width:100%;height:100%;display:block;border-radius:50%;object-fit:cover;border:4px solid rgba(255,255,255,.12)}

  .meta{flex:1;min-width:0}
  .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:22px;line-height:1.2;text-shadow:0 2px 8px rgba(0,0,0,.35)}
  .artist{margin:.25rem 0 0;color:#e0cade;font-weight:600;opacity:.95}

  .times{margin:.9rem 0 .35rem;display:flex;justify-content:space-between;font-variant-numeric:tabular-nums;font-weight:700;color:var(--muted)}
  .times .right{color:var(--accent)}
  .progress{height:8px;border-radius:999px;position:relative;overflow:hidden;background:var(--bar-bg)}
  .bar{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg, color-mix(in oklab, var(--accent) 95%, white 0%), color-mix(in oklab, var(--accent) 70%, white 20%))}

  .empty{text-align:center;padding:28px 22px;color:#e0cade;opacity:.85}

  .recent{margin-top:14px;display:grid;grid-template-columns:repeat(3, minmax(0, 1fr));gap:12px;width:100%}
  .chip{
    width:100%;display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;
    background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10);text-decoration:none;color:var(--text);min-width:0;min-height:64px
  }
  .chip:hover{border-color: color-mix(in oklab, var(--accent) 40%, white 0%)}
  .chip img{width:40px;height:40px;border-radius:8px;object-fit:cover;flex:0 0 auto;background:#222}
  .chip .text{min-width:0}
  .chip .t{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chip .a{font-size:12px;color:#d7c7df;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:.95}

  @media (max-width:560px){ .recent{grid-template-columns:repeat(2, minmax(0, 1fr))} }
</style>
</head>
<body>
  <div class="wrap">
    <a id="cardLink" class="card" aria-live="polite" target="_blank" rel="noopener">
      <div id="bg" class="bg"></div>
      <div id="content" class="row" hidden>
        <div class="cover"><img id="cover" alt="Omslag"></div>
        <div class="meta">
          <h1 id="title" class="title">–</h1>
          <div id="artist" class="artist">–</div>
          <div class="times"><div id="tStart">00:00</div><div id="tEnd" class="right">00:00</div></div>
          <div class="progress"><div id="bar" class="bar"></div></div>
        </div>
      </div>
      <div id="empty" class="empty">Ingen låt spelas just nu.</div>
    </a>

    <div id="recent" class="recent" aria-label="Senaste låtar"></div>
  </div>

<script>
  const API_NOW="/now-playing";
  const API_REC="/recent";

  const el={
    cardLink:gid("cardLink"), bg:gid("bg"), content:gid("content"), empty:gid("empty"),
    cover:gid("cover"), title:gid("title"), artist:gid("artist"),
    tStart:gid("tStart"), tEnd:gid("tEnd"), bar:gid("bar"),
    recent:gid("recent")
  };
  function gid(id){return document.getElementById(id)}

  const ms=(x=0)=>{x=Math.max(0,x|0);const s=Math.floor(x/1000),m=Math.floor(s/60);return `${m}:${String(s%60).padStart(2,"0")}`};
  const esc=s=>String(s).replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));

  async function dominantColorFromURL(url){
    return new Promise((resolve)=>{
      const img=new Image(); img.crossOrigin="anonymous";
      img.onload=()=>{
        const w=50,h=50; const c=document.createElement("canvas"); c.width=w;c.height=h;
        const ctx=c.getContext("2d",{willReadFrequently:true}); ctx.drawImage(img,0,0,w,h);
        const d=ctx.getImageData(0,0,w,h).data; let r=0,g=0,b=0,n=0;
        for(let i=0;i<d.length;i+=4){ if(d[i+3]<128) continue; r+=d[i];g+=d[i+1];b+=d[i+2]; n++; }
        resolve(n?`rgb(${Math.round(r/n)},${Math.round(g/n)},${Math.round(b/n)})`:"#c84cff");
      };
      img.onerror=()=>resolve("#c84cff");
      img.src=url;
    });
  }
  const setAccent=c=>document.documentElement.style.setProperty("--accent",c);

  let now=null;

  // —— NOW
  function paintNow(d){
    if(!d||!d.playing){
      el.content.hidden=true; el.empty.hidden=false; el.bg.style.backgroundImage=""; el.cardLink.href="#"; now=null; return;
    }
    now=d;
    el.content.hidden=false; el.empty.hidden=true;
    el.title.textContent=d.title||"Okänd låt";
    el.artist.textContent=(d.artists||[]).join(", ")||d.album||"";
    const p=d.progress_ms||0,t=d.duration_ms||1;
    el.tStart.textContent=ms(p); el.tEnd.textContent=ms(t);
    el.bar.style.width=(100*p/t)+"%";
    if(d.image){ el.cover.src=d.image; el.bg.style.backgroundImage=`url("${d.image}")`; dominantColorFromURL(d.image).then(setAccent); }
    el.cardLink.href=d.url||"#";
  }

  // —— RECENT (stabil med id@played_at + serialisering)
  let recentKey="";               // "id@played|id@played|id@played"
  let recCtl=null, nowCtl=null;   // AbortController
  let recSeq=0, recLastHandled=0; // sekvensräknare

  function calcKey(list){
    return list.slice(0,3).map(it=>`${it.id||"-"}@${it.played_at||"-"}`).join("|");
  }
  function sortClean(list){
    // sortera NYAST först enligt played_at (servern ska redan göra detta, men vi säkrar)
    const arr = (list||[]).slice().filter(it=>it && it.id && it.played_at);
    arr.sort((a,b)=> new Date(b.played_at).getTime() - new Date(a.played_at).getTime());
    // dedupe på id@played_at (bevara unika instanser)
    const seen=new Set(), out=[];
    for(const it of arr){
      const k=`${it.id}@${it.played_at}`;
      if(seen.has(k)) continue;
      seen.add(k); out.push(it);
      if(out.length>=3) break;
    }
    return out;
  }

  function paintRecent(list){
    const three = sortClean(list);
    const key = calcKey(three);
    if(key===recentKey) return;      // ingen faktisk ändring
    recentKey = key;

    el.recent.innerHTML="";
    for(const it of three){
      const a=document.createElement("a");
      a.className="chip"; a.href=it.url||"#"; a.target="_blank"; a.rel="noopener";
      a.innerHTML=`
        <img src="${esc(it.image||"")}" alt="">
        <div class="text">
          <div class="t">${esc(it.title||"")}</div>
          <div class="a">${esc((it.artists||[]).join(", "))}</div>
        </div>`;
      el.recent.appendChild(a);
    }
    for(let k=three.length;k<3;k++){ const ph=document.createElement("div"); ph.className="chip"; ph.style.visibility="hidden"; el.recent.appendChild(ph); }
  }

  // —— Pollers (abort + sekvenser)
  async function pollNow(){
    try{
      if(nowCtl) nowCtl.abort();
      nowCtl = new AbortController();
      const r=await fetch(API_NOW,{cache:"no-store", signal:nowCtl.signal});
      const data=await r.json();
      paintNow(data);
    }catch{}
  }

  async function pollRecent(){
    const mySeq=++recSeq;
    try{
      if(recCtl) recCtl.abort();
      recCtl = new AbortController();
      const qs = now?.id ? `?exclude_id=${encodeURIComponent(now.id)}` : "";
      const r = await fetch(API_REC+qs,{cache:"no-store", signal:recCtl.signal});
      const data = await r.json();
      if(mySeq<recLastHandled) return; // ignorera sena svar
      recLastHandled = mySeq;
      paintRecent(Array.isArray(data.items)?data.items:[]);
    }catch{}
  }

  // —— Start
  pollNow(); pollRecent();
  setInterval(pollNow, 1000);   // /currently-playing kan returnera 204 ibland – enligt spec. :contentReference[oaicite:3]{index=3}
  setInterval(pollRecent, 1200);
</script>
</body>
</html>
