<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Song Overlay (OBS safe)</title>
<style>
  :root{
    --duration-ms: 10000;      /* visas i 10 s */
    --scale: 1;
    --offset-bottom: 24px;
    --offset-x: 50%;           /* 0% = vänster, 50% = mitt, 100% = höger */
    --max-width: 780px;
    --radius: 20px;

    /* färger/glas */
    --accent: #c84cff;
    --text: #fff; --muted: #e7d9ef;
    --glass: rgba(14, 10, 18, .78);          /* MER OPAC för kontrast i OBS */
    --glass-border: rgba(255,255,255,.14);
    --bar-bg: rgba(255,255,255,.16);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:transparent; overflow:hidden;
        font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--text);
        -webkit-font-smoothing:antialiased; }

  /* container som slidar upp */
  .tray{
    position:fixed; left:var(--offset-x); bottom:0;
    transform:translate(-50%, 140%) scale(var(--scale));
    transition:transform 520ms cubic-bezier(.2,.9,.2,1);
    width:min(var(--max-width), 94vw); pointer-events:none;
    filter: drop-shadow(0 18px 40px rgba(0,0,0,.6));
  }
  .tray.show{ transform:translate(-50%, calc(-1 * var(--offset-bottom))) scale(var(--scale)); }

  /* kortet */
  .card{
    position:relative; width:100%; padding:18px 22px 20px; border-radius:var(--radius);
    overflow:hidden; isolation:isolate; color:inherit; text-decoration:none;
    background:var(--glass); border:1px solid var(--glass-border);
    backdrop-filter:saturate(120%) blur(10px);   /* MINDRE blur i OBS */
  }
  /* blurrad album-bakgrund – svagare, mörkare */
  .bg{
    position:absolute; inset:0; background-size:cover; background-position:center;
    filter: blur(16px) saturate(115%) brightness(0.55);  /* ↓ brightness, ↓ blur */
    transform:scale(1.08); opacity:.55; z-index:-2;
  }
  /* mörk gradient för läsbarhet */
  .card::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(115deg, rgba(10,6,14,.85), rgba(10,6,14,.55));
    z-index:-1;
  }

  .row{display:grid; grid-template-columns:auto 1fr auto; gap:16px; align-items:center}

  .cover{
    width:90px;height:90px; border-radius:16px; padding:5px;
    background:radial-gradient(closest-side, rgba(255,255,255,.18), transparent 70%), rgba(255,255,255,.12);
    box-shadow: 0 6px 18px rgba(0,0,0,.45);
  }
  .cover img{ width:100%; height:100%; display:block; border-radius:12px; object-fit:cover; }

  .meta{min-width:0}
  .title{ margin:0; font-weight:900; font-size:22px; line-height:1.15;
          text-shadow:0 2px 8px rgba(0,0,0,.55); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .artist{ margin:.25rem 0 0; color:var(--muted); font-weight:600; opacity:.95;
           white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .times{ margin:.7rem 0 .35rem; display:flex; justify-content:space-between;
          font-variant-numeric:tabular-nums; font-weight:700; color:#efe6f5d0; font-size:13px; }
  .progress{ height:8px; border-radius:999px; position:relative; overflow:hidden;
             background:var(--bar-bg); box-shadow:inset 0 0 0 1px rgba(255,255,255,.07); }
  .bar{ position:absolute; left:0; top:0; bottom:0; width:0;
        background:linear-gradient(90deg, color-mix(in oklab, var(--accent) 92%, white 0%), color-mix(in oklab, var(--accent) 65%, white 12%)); }

  .by{ grid-column:3; align-self:start; justify-self:end; font-size:12px; color:#f6e9f5e0;
       padding:.2rem .5rem; border-radius:999px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.15); }

  /* Marquee när titeln inte får plats */
  .marquee{ --w: 100%;
    mask: linear-gradient(90deg, transparent 0, #000 18px, #000 calc(100% - 18px), transparent 100%);
  }
  .marquee > span{ display:inline-block; padding-right:36px; animation: marquee 9s linear infinite paused; }
  .marquee.scroll > span{ animation-play-state: running; }
  @keyframes marquee{ from{transform:translateX(0)} to{transform:translateX(calc(-100% + var(--w)))} }

  @media (max-width:560px){
    :root{ --scale:.95 } .cover{width:82px;height:82px} .title{font-size:20px}
  }
</style>
</head>
<body>
<div id="tray" class="tray" aria-live="polite">
  <a id="card" class="card" target="_blank" rel="noopener">
    <div id="bg" class="bg"></div>
    <div class="row">
      <div class="cover"><img id="cover" alt="Omslag"></div>
      <div class="meta">
        <h1 id="title" class="title marquee"><span>–</span></h1>
        <div id="artist" class="artist">–</div>
        <div class="times"><div id="tStart">00:00</div><div id="tEnd">00:00</div></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </div>
      <div id="by" class="by"></div>
    </div>
  </a>
</div>

<script>
  const API_NOW="/now-playing", API_SNAP="/now-snapshot";
  const el={ tray:byId("tray"), card:byId("card"), bg:byId("bg"), cover:byId("cover"),
    title:byId("title"), artist:byId("artist"), tStart:byId("tStart"), tEnd:byId("tEnd"), bar:byId("bar"), by:byId("by") };
  function byId(id){return document.getElementById(id)}
  const ms=(x=0)=>{x=Math.max(0,x|0);const s=Math.floor(x/1000),m=Math.floor(s/60);return `${m}:${String(s%60).padStart(2,"0")}`};

  async function dominantColorFromURL(url){
    return new Promise((resolve)=>{
      const img=new Image(); img.crossOrigin="anonymous";
      img.onload=()=>{
        const c=document.createElement("canvas"); c.width=c.height=48;
        const g=c.getContext("2d",{willReadFrequently:true}); g.drawImage(img,0,0,48,48);
        const d=g.getImageData(0,0,48,48).data; let r=0,gc=0,b=0,n=0;
        for(let i=0;i<d.length;i+=4){ if(d[i+3]<128) continue; r+=d[i]; gc+=d[i+1]; b+=d[i+2]; n++; }
        if(!n) return resolve("#c84cff"); resolve(`rgb(${Math.round(r/n)},${Math.round(gc/n)},${Math.round(b/n)})`);
      }; img.onerror=()=>resolve("#c84cff"); img.src=url;
    });
  }
  const setAccent=(c)=>document.documentElement.style.setProperty("--accent",c);

  function applyMarqueeIfNeeded(){
    const span=el.title.querySelector("span");
    requestAnimationFrame(()=>{
      const w=el.title.clientWidth; el.title.style.setProperty("--w", w+"px");
      if(span.scrollWidth> w+6) el.title.classList.add("scroll"); else el.title.classList.remove("scroll");
    });
  }

  function paint(now, who){
    if(!now||!now.playing) return false;
    el.title.innerHTML=`<span>${(now.title||"Okänd låt").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span>`;
    applyMarqueeIfNeeded();
    el.artist.textContent=(now.artists||[]).join(", ")||now.album||"";
    const p=now.progress_ms||0,t=now.duration_ms||1; el.tStart.textContent=ms(p); el.tEnd.textContent=ms(t); el.bar.style.width=(100*p/t)+"%";
    if(now.image){ el.cover.src=now.image; el.bg.style.backgroundImage=`url("${now.image}")`; dominantColorFromURL(now.image).then(setAccent); }
    el.card.href=now.url||"#"; el.by.textContent=who?`av ${who}`:"";
    return true;
  }

  let hideTimer=null;
  function showFor(ms = Number(getComputedStyle(document.documentElement).getPropertyValue("--duration-ms"))||10000){
    clearTimeout(hideTimer); el.tray.classList.add("show"); hideTimer=setTimeout(()=>el.tray.classList.remove("show"), ms);
  }

  async function fetchNowWithRetry(maxTries=5, delayMs=250){
    for(let i=0;i<maxTries;i++){
      try{ const r=await fetch(API_NOW,{cache:"no-store"}); const data=await r.json(); if(data&&data.playing) return data; }catch{}
      await new Promise(r=>setTimeout(r,delayMs));
    }
    try{ const r=await fetch(API_SNAP,{cache:"no-store"}); const s=await r.json(); if(s&&s.playing) return s; }catch{}
    return {playing:false};
  }

  async function handleSongTrigger(who){ const now=await fetchNowWithRetry(6,250); if(paint(now,who)) showFor(); }

  /* SSE från servern (tmi.js skickar "song" vid !song/!låt) */
  const es=new EventSource("/events");
  es.addEventListener("song",(ev)=>{ let by=null; try{by=JSON.parse(ev.data).by||null;}catch{} handleSongTrigger(by); });

  /* Test i browsern: tryck S */
  addEventListener("keydown",(e)=>{ if(e.key.toLowerCase()==="s") handleSongTrigger("debug"); });
  addEventListener("resize",applyMarqueeIfNeeded);
</script>
</body>
</html>
