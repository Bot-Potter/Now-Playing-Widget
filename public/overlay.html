<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Song Overlay</title>
<style>
  :root{ --accent:#c84cff; --text:#f6e9f5; --muted:#e9d3f2; --bar-bg:rgba(255,255,255,.16); --radius:18px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:transparent;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter;color:var(--text);
    overflow:hidden;
  }

  .tray{
    position:fixed; left:50%; bottom:0; transform:translate(-50%, 120%);
    transition:transform 420ms cubic-bezier(.2,.9,.2,1);
    will-change:transform;
    width:min(720px, 92vw);
    pointer-events:none;
  }
  .tray.show{ transform:translate(-50%, -14px); }

  .card{
    position:relative;width:100%;padding:16px 20px 18px;border-radius:var(--radius);
    overflow:hidden;box-shadow:0 16px 40px rgba(0,0,0,.5);
    text-decoration:none;color:inherit;background:rgba(12,8,15,.7);backdrop-filter: blur(10px);
  }
  .bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(22px) saturate(130%) brightness(70%);transform:scale(1.1);z-index:-2;opacity:.65}
  .card::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(18,8,22,.60),rgba(35,10,35,.36));z-index:-1}

  .row{display:flex;align-items:center;gap:16px}
  .cover{width:88px;height:88px;flex:0 0 auto;border-radius:50%;padding:5px;background:radial-gradient(closest-side, color-mix(in oklab, var(--accent) 40%, transparent), transparent 68%), var(--accent)}
  .cover img{width:100%;height:100%;display:block;border-radius:50%;object-fit:cover;border:4px solid rgba(255,255,255,.12)}

  .meta{flex:1;min-width:0}
  .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:20px;line-height:1.2;text-shadow:0 2px 8px rgba(0,0,0,.35)}
  .artist{margin:.2rem 0 0;color:var(--muted);font-weight:600;opacity:.95;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .times{margin:.5rem 0 .25rem;display:flex;justify-content:space-between;font-variant-numeric:tabular-nums;font-weight:700;color:var(--muted);font-size:12px}
  .progress{height:6px;border-radius:999px;position:relative;overflow:hidden;background:var(--bar-bg)}
  .bar{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg, color-mix(in oklab, var(--accent) 95%, white 0%), color-mix(in oklab, var(--accent) 70%, white 20%))}

  .by{position:absolute;right:12px;top:8px;font-size:11px;color:#e9d3f2b3}
</style>
</head>
<body>

<div id="tray" class="tray" aria-live="polite">
  <a id="card" class="card" target="_blank" rel="noopener">
    <div id="bg" class="bg"></div>
    <div class="row">
      <div class="cover"><img id="cover" alt="Omslag"></div>
      <div class="meta">
        <h1 id="title" class="title">–</h1>
        <div id="artist" class="artist">–</div>
        <div class="times"><div id="tStart">00:00</div><div id="tEnd">00:00</div></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </div>
    </div>
    <div id="by" class="by"></div>
  </a>
</div>

<script>
  const API_NOW = "/now-playing";

  const el = {
    tray:document.getElementById("tray"),
    card:document.getElementById("card"),
    bg:document.getElementById("bg"),
    cover:document.getElementById("cover"),
    title:document.getElementById("title"),
    artist:document.getElementById("artist"),
    tStart:document.getElementById("tStart"),
    tEnd:document.getElementById("tEnd"),
    bar:document.getElementById("bar"),
    by:document.getElementById("by")
  };

  const ms=(x=0)=>{x=Math.max(0,x|0);const s=Math.floor(x/1000),m=Math.floor(s/60);return `${m}:${String(s%60).padStart(2,"0")}`};

  async function dominantColorFromURL(url){
    return new Promise((resolve)=>{
      const img=new Image(); img.crossOrigin="anonymous";
      img.onload=()=>{
        const w=50,h=50; const c=document.createElement("canvas"); c.width=w;c.height=h;
        const ctx=c.getContext("2d",{willReadFrequently:true}); ctx.drawImage(img,0,0,w,h);
        const {data}=ctx.getImageData(0,0,w,h); let r=0,g=0,b=0,n=0;
        for(let i=0;i<data.length;i+=4){ if(data[i+3]<128) continue; r+=data[i];g+=data[i+1];b+=data[i+2]; n++; }
        if(!n) return resolve("#c84cff"); r=Math.round(r/n);g=Math.round(g/n);b=Math.round(b/n);
        resolve(`rgb(${r},${g},${b})`);
      };
      img.onerror=()=>resolve("#c84cff");
      img.src=url;
    });
  }
  const setAccent=(c)=>document.documentElement.style.setProperty("--accent",c);

  function paint(now, who){
    if(!now||!now.playing) return false;
    el.title.textContent = now.title || "Okänd låt";
    el.artist.textContent = (now.artists||[]).join(", ") || now.album || "";
    const p = now.progress_ms||0, t = now.duration_ms||1;
    el.tStart.textContent = ms(p); el.tEnd.textContent = ms(t);
    el.bar.style.width = (100*p/t) + "%";
    if(now.image){
      el.cover.src = now.image;
      el.bg.style.backgroundImage = `url("${now.image}")`;
      dominantColorFromURL(now.image).then(setAccent);
    }
    el.card.href = now.url || "#";
    el.by.textContent = who ? `av ${who}` : "";
    return true;
  }

  let hideTimer = null;
  function showFor(ms=15000){
    clearTimeout(hideTimer);
    el.tray.classList.add("show");
    hideTimer = setTimeout(()=> el.tray.classList.remove("show"), ms);
  }

  async function handleSongTrigger(who){
    try{
      console.log("[Overlay] Trigger från", who);
      const r = await fetch(API_NOW, { cache:"no-store" });
      const now = await r.json();
      console.log("[Overlay] Fick låt:", now);
      if (paint(now, who)) showFor(15000);
    }catch(e){
      console.error("[Overlay] Fel vid handleSongTrigger", e);
    }
  }

  // SSE från servern
  const es = new EventSource("/events");
  es.onopen = () => console.log("[SSE] connected");
  es.addEventListener("song", (ev)=>{
    console.log("[SSE] song event", ev.data);
    let by = null;
    try { by = JSON.parse(ev.data).by || null; } catch {}
    handleSongTrigger(by);
  });
  es.onerror = (err) => console.error("[SSE] error", err);

  // Testtrigger med tangent S
  window.addEventListener("keydown", (e)=>{ if(e.key.toLowerCase()==="s") handleSongTrigger("debug"); });
</script>
</body>
</html>
