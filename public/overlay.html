<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Song Overlay</title>
<style>
  /* ======= Snabba justeringar (ändra dessa) ======= */
  :root{
    --scale: 1;                 /* 0.8–1.3 beroende på din scen */
    --offset-bottom: 24px;      /* hur högt över botten kortet stannar */
    --offset-x: 50%;            /* 0% = vänster, 50% = centrerat, 100% = höger */
    --max-width: 820px;         /* kortets maxbredd */
    --radius: 22px;
    --accent: #c84cff;          /* ersätts automatiskt av albumdominant */
    --text: #fff;               /* baskulör för text */
    --muted: #e7d9ef;
    --glass: rgba(10, 6, 14, .55);   /* glaslager ovanpå blurrad bg */
    --glass-border: rgba(255,255,255,.18);
    --glow: color-mix(in oklab, var(--accent) 60%, transparent);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:transparent; overflow:hidden;
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    color:var(--text);
  }

  /* ======= Container: sitter i botten och animeras upp/ner ======= */
  .tray{
    position:fixed; left:var(--offset-x); bottom:0;
    transform:translate(-50%, 140%) scale(var(--scale));
    transition:transform 520ms cubic-bezier(.2,.9,.2,1);
    will-change:transform;
    width:min(var(--max-width), 94vw);
    pointer-events:none;
    filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
  }
  .tray.show{ transform:translate(-50%, calc(-1 * var(--offset-bottom))) scale(var(--scale)); }

  /* ======= Kort ======= */
  .card{
    position:relative; width:100%; padding:18px 22px 20px; border-radius:var(--radius);
    overflow:hidden; isolation:isolate; text-decoration:none; color:inherit;
    background:var(--glass); border:1px solid var(--glass-border);
    backdrop-filter:saturate(130%) blur(14px);
  }
  /* blurrad album-bild i bakgrunden */
  .bg{
    position:absolute; inset:0; background-size:cover; background-position:center;
    filter:blur(28px) saturate(130%) brightness(75%); transform:scale(1.15);
    opacity:.85; z-index:-2;
  }
  /* toning för läsbarhet */
  .card::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(115deg, rgba(18,10,24,.70), rgba(18,10,24,.35));
    z-index:-1;
  }
  /* accentglow runt kortet */
  .card::before{
    content:""; position:absolute; inset:-2px; border-radius:inherit; z-index:-3;
    background: radial-gradient(120px 80px at 16% 20%, var(--glow), transparent 70%),
                radial-gradient(160px 100px at 85% 80%, var(--glow), transparent 70%);
    filter: blur(18px); opacity:.55; pointer-events:none;
  }

  /* ======= Layout ======= */
  .row{display:grid; grid-template-columns:auto 1fr auto; gap:18px; align-items:center}

  /* Omslag (rund kapsel med accent-ring) */
  .cover{
    width:96px;height:96px; border-radius:18px; padding:5px; flex:0 0 auto;
    background:
      radial-gradient(closest-side, color-mix(in oklab, var(--accent) 40%, transparent), transparent 70%),
      var(--accent);
    box-shadow: 0 8px 26px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.12) inset;
  }
  .cover img{
    width:100%; height:100%; display:block; border-radius:14px; object-fit:cover;
    border:4px solid rgba(255,255,255,.12);
  }

  /* Metadata */
  .meta{min-width:0}
  .title{
    margin:0; font-weight:900; letter-spacing:.2px; font-size:22px; line-height:1.15;
    text-shadow:0 2px 8px rgba(0,0,0,.45), 0 0 1px rgba(0,0,0,.8);
    overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
  }
  .artist{
    margin:.28rem 0 0; color:var(--muted); font-weight:600; opacity:.94;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* Progress & tider – diskreta men tydliga */
  .times{
    margin:.7rem 0 .35rem; display:flex; justify-content:space-between;
    font-variant-numeric:tabular-nums; font-weight:700; color:#e7d9efcc; font-size:13px;
    text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  .progress{
    height:8px; border-radius:999px; position:relative; overflow:hidden;
    background:rgba(255,255,255,.16);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
  }
  .bar{
    position:absolute; left:0; top:0; bottom:0; width:0;
    background:linear-gradient(90deg,
      color-mix(in oklab, var(--accent) 95%, white 0%),
      color-mix(in oklab, var(--accent) 70%, white 15%)
    );
    box-shadow: 0 0 16px color-mix(in oklab, var(--accent) 40%, transparent);
  }

  /* “av <user>” etikett */
  .by{
    grid-column:3; align-self:start; justify-self:end;
    font-size:12px; color:#f6e9f5cc; padding:.2rem .5rem; border-radius:999px;
    background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.16);
    text-shadow:0 1px 1px rgba(0,0,0,.35);
  }

  /* Liten scroll-animation om titeln är för lång (auto-detect via :has) – modern, funkar i OBS Chromium */
  .marquee{ --w: 100%;
    mask: linear-gradient(90deg, transparent 0, #000 24px, #000 calc(100% - 24px), transparent 100%);
  }
  .marquee > span{
    display:inline-block; padding-right:48px;
    animation: marquee 10s linear infinite paused;
  }
  .marquee.scroll > span{ animation-play-state: running; }
  @keyframes marquee{
    from{ transform:translateX(0) }
    to{ transform:translateX(calc(-100% + var(--w))) }
  }

  @media (max-width: 560px){
    :root{ --scale: .94 }
    .cover{ width:84px; height:84px }
    .title{ font-size:20px }
  }
</style>
</head>
<body>

<div id="tray" class="tray" aria-live="polite">
  <a id="card" class="card" target="_blank" rel="noopener">
    <div id="bg" class="bg"></div>

    <div class="row">
      <div class="cover"><img id="cover" alt="Omslag"></div>

      <div class="meta">
        <h1 id="title" class="title marquee"><span>–</span></h1>
        <div id="artist" class="artist">–</div>
        <div class="times"><div id="tStart">00:00</div><div id="tEnd">00:00</div></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </div>

      <div id="by" class="by"></div>
    </div>
  </a>
</div>

<script>
  const API_NOW = "/now-playing";
  const API_SNAPSHOT = "/now-snapshot"; // se server.js patch

  const el = {
    tray:document.getElementById("tray"),
    card:document.getElementById("card"),
    bg:document.getElementById("bg"),
    cover:document.getElementById("cover"),
    title:document.getElementById("title"),
    artist:document.getElementById("artist"),
    tStart:document.getElementById("tStart"),
    tEnd:document.getElementById("tEnd"),
    bar:document.getElementById("bar"),
    by:document.getElementById("by")
  };

  const ms=(x=0)=>{x=Math.max(0,x|0);const s=Math.floor(x/1000),m=Math.floor(s/60);return `${m}:${String(s%60).padStart(2,"0")}`};

  async function dominantColorFromURL(url){
    return new Promise((resolve)=>{
      const img=new Image(); img.crossOrigin="anonymous";
      img.onload=()=>{
        const w=50,h=50; const c=document.createElement("canvas"); c.width=w;c.height=h;
        const ctx=c.getContext("2d",{willReadFrequently:true}); ctx.drawImage(img,0,0,w,h);
        const {data}=ctx.getImageData(0,0,w,h); let r=0,g=0,b=0,n=0;
        for(let i=0;i<data.length;i+=4){ if(data[i+3]<128) continue; r+=data[i];g+=data[i+1];b+=data[i+2]; n++; }
        if(!n) return resolve("#c84cff"); r=Math.round(r/n);g=Math.round(g/n);b=Math.round(b/n);
        resolve(`rgb(${r},${g},${b})`);
      };
      img.onerror=()=>resolve("#c84cff");
      img.src=url;
    });
  }
  const setAccent=(c)=>document.documentElement.style.setProperty("--accent",c);

  function applyMarqueeIfNeeded(){
    // Om texten är bredare än sin container → starta scroll
    const span = el.title.querySelector("span");
    // uppdatera innehållsbredd
    requestAnimationFrame(()=>{
      const w = el.title.clientWidth;
      el.title.style.setProperty("--w", w + "px");
      // lägg på/ta bort klass
      if (span.scrollWidth > w + 8) el.title.classList.add("scroll");
      else el.title.classList.remove("scroll");
    });
  }

  function paint(now, who){
    if(!now||!now.playing) return false;
    // Title (marquee wrapper)
    el.title.innerHTML = `<span>${(now.title || "Okänd låt")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span>`;
    applyMarqueeIfNeeded();

    el.artist.textContent = (now.artists||[]).join(", ") || now.album || "";
    const p = now.progress_ms||0, t = now.duration_ms||1;
    el.tStart.textContent = ms(p); el.tEnd.textContent = ms(t);
    el.bar.style.width = (100*p/t) + "%";

    if(now.image){
      el.cover.src = now.image;
      el.bg.style.backgroundImage = `url("${now.image}")`;
      dominantColorFromURL(now.image).then(setAccent);
    }
    el.card.href = now.url || "#";
    el.by.textContent = who ? `av ${who}` : "";
    return true;
  }

  let hideTimer = null;
  function showFor(ms=15000){
    clearTimeout(hideTimer);
    el.tray.classList.add("show");
    hideTimer = setTimeout(()=> el.tray.classList.remove("show"), ms);
  }

  // Retry + snapshot fallback – för att undvika “playing:false” precis vid kommandot
  async function fetchNowWithRetry(maxTries=6, delayMs=300){
    for (let i=0;i<maxTries;i++){
      try{
        const r = await fetch(API_NOW,{cache:"no-store"});
        const now = await r.json();
        if (now && now.playing) return now;
      }catch{}
      await new Promise(r=>setTimeout(r, delayMs));
    }
    try{
      const s = await fetch(API_SNAPSHOT,{cache:"no-store"});
      const snap = await s.json();
      if (snap && snap.playing) return snap;
    }catch{}
    return { playing:false };
  }

  async function handleSongTrigger(who){
    try{
      const now = await fetchNowWithRetry(6, 300);
      if (paint(now, who)) showFor(15000);
    }catch{}
  }

  // SSE
  const es = new EventSource("/events");
  es.onopen = () => console.log("[SSE] connected");
  es.addEventListener("song", (ev)=>{
    let by = null;
    try { by = JSON.parse(ev.data).by || null; } catch {}
    handleSongTrigger(by);
  });
  es.onerror = (err) => console.error("[SSE] error", err);

  // Manuell test: tryck S
  window.addEventListener("keydown", (e)=>{ if(e.key.toLowerCase()==="s") handleSongTrigger("debug"); });

  // Re-calc marquee vid resize
  window.addEventListener("resize", applyMarqueeIfNeeded);
</script>
</body>
</html>
