<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Song Overlay (clean & ticking)</title>
<style>
  :root{
    --scale: 1;
    --pos-x: 50%;              /* 0% vänster, 50% mitt, 100% höger (kan styras via ?pos=) */
    --offset-bottom: 24px;     /* ?y= */
    --max-width: 780px;
    --radius: 18px;

    --accent:#c84cff;          /* ersätts från albumet */
    --text:#fff; --muted:#e7d9ef;
    --glass: rgba(14,10,18,.85);
    --glass-border: rgba(255,255,255,.15);
    --bar-bg: rgba(255,255,255,.2);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:transparent; overflow:hidden;
        font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--text); }

  .tray{
    position:fixed; left:var(--pos-x); bottom:0;
    transform:translate(-50%, 140%) scale(var(--scale));
    transition:transform 520ms cubic-bezier(.2,.9,.2,1);
    width:min(var(--max-width), 94vw); pointer-events:none;
    filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
  }
  .tray.show{ transform:translate(-50%, calc(-1 * var(--offset-bottom))) scale(var(--scale)); }

  .card{
    position:relative; isolation:isolate;
    display:block; color:inherit; text-decoration:none;
    width:100%; padding:16px 18px 18px; border-radius:var(--radius);
    background:var(--glass); border:1px solid var(--glass-border);
    backdrop-filter:saturate(115%) blur(6px);
  }
  .bg{ position:absolute; inset:0; background-size:cover; background-position:center;
       filter: blur(10px) saturate(110%) brightness(0.6);
       transform:scale(1.04); opacity:.45; z-index:-1; }
  .no-blur .bg{ display:none; }

  .row{ display:grid; grid-template-columns:auto 1fr auto; gap:14px; align-items:center }
  .cover{ width:86px; height:86px; border-radius:14px; padding:4px;
          background:rgba(255,255,255,.10); box-shadow:0 6px 18px rgba(0,0,0,.45); }
  .cover img{ width:100%; height:100%; border-radius:10px; object-fit:cover; display:block; }

  .meta{ min-width:0 }
  .title{ margin:0; font-weight:900; font-size:22px; line-height:1.15;
          text-shadow:0 2px 8px rgba(0,0,0,.6); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .artist{ margin:.25rem 0 0; color:var(--muted); font-weight:600; opacity:.96;
           white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .times{ margin:.65rem 0 .35rem; display:flex; justify-content:space-between;
          font-variant-numeric:tabular-nums; font-weight:700; color:#f0e7f5e0; font-size:13px; }
  .progress{ height:8px; border-radius:999px; position:relative; overflow:hidden;
             background:var(--bar-bg); box-shadow:inset 0 0 0 1px rgba(255,255,255,.08); }
  .bar{ position:absolute; left:0; top:0; bottom:0; width:0;
        background:linear-gradient(90deg,
          color-mix(in oklab, var(--accent) 92%, white 0%),
          color-mix(in oklab, var(--accent) 65%, white 12%)); }

  .by{ grid-column:3; align-self:start; justify-self:end;
       font:600 12px/1.1 Inter,system-ui; color:#fff;
       padding:.22rem .55rem; border-radius:999px; background:rgba(255,255,255,.12);
       border:1px solid rgba(255,255,255,.18); }

  @media (max-width:560px){ :root{ --scale:.96 } .cover{width:78px;height:78px} .title{font-size:20px} }
</style>
</head>
<body>
<div id="tray" class="tray" aria-live="polite">
  <a id="card" class="card" target="_blank" rel="noopener">
    <div id="bg" class="bg"></div>
    <div class="row">
      <div class="cover"><img id="cover" alt="Omslag"></div>
      <div class="meta">
        <h1 id="title" class="title">–</h1>
        <div id="artist" class="artist">–</div>
        <div class="times"><div id="tStart">00:00</div><div id="tEnd">00:00</div></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </div>
      <div id="by" class="by"></div>
    </div>
  </a>
</div>

<script>
  /* ===== URL-parametrar =====
     ?pos=left|center|right
     ?scale=1.0
     ?y=24                  (px)
     ?blur=0|1              (0 = stäng av blurrad bg, 1 = på)
     ?dur=10                (sekunder visningstid, default 10)
     ?tick=250              (ms lokaltik – hur ofta vi uppdaterar progress/tider; default 250)
     ?sync=1000             (ms resync mot server – minst 1000ms)
  */
  const q = new URLSearchParams(location.search); // URLSearchParams för att läsa queryn. :contentReference[oaicite:0]{index=0}
  const pos=(q.get("pos")||"center").toLowerCase();
  document.documentElement.style.setProperty("--pos-x", pos==="left"?"0%":pos==="right"?"100%":"50%");
  if(q.get("scale")) document.documentElement.style.setProperty("--scale", q.get("scale"));
  if(q.get("y")) document.documentElement.style.setProperty("--offset-bottom", q.get("y")+"px");
  const useBlur = q.get("blur")==="1";
  const DUR_MS  = Math.max(1000, (parseFloat(q.get("dur"))||10)*1000);
  const TICK_MS = Math.max(100, parseInt(q.get("tick")||"250",10));
  const SYNC_MS = Math.max(1000, parseInt(q.get("sync")||"1000",10));

  const API_NOW="/now-playing", API_SNAP="/now-snapshot";
  const $=id=>document.getElementById(id);
  const el={ tray:$("tray"), card:$("card"), bg:$("bg"), cover:$("cover"),
             title:$("title"), artist:$("artist"), tStart:$("tStart"), tEnd:$("tEnd"), bar:$("bar"), by:$("by") };
  if(!useBlur) el.card.classList.add("no-blur");

  const ms=x=>{ x=Math.max(0, x|0); const s=Math.floor(x/1000), m=Math.floor(s/60); return `${m}:${String(s%60).padStart(2,"0")}`; };

  async function dominantColorFromURL(url){
    return new Promise((resolve)=>{
      const img=new Image(); img.crossOrigin="anonymous";
      img.onload=()=>{
        const c=document.createElement("canvas"); c.width=c.height=48;
        const g=c.getContext("2d",{willReadFrequently:true}); g.drawImage(img,0,0,48,48);
        const d=g.getImageData(0,0,48,48).data; let r=0,gn=0,b=0,n=0;
        for(let i=0;i<d.length;i+=4){ if(d[i+3]<128) continue; r+=d[i];gn+=d[i+1];b+=d[i+2];n++; }
        if(!n) return resolve("#c84cff"); resolve(`rgb(${Math.round(r/n)},${Math.round(gn/n)},${Math.round(b/n)})`);
      }; img.onerror=()=>resolve("#c84cff"); img.src=url;
    });
  }
  const setAccent=c=>document.documentElement.style.setProperty("--accent", c);

  function paintStatic(d, who){
    // Paint statiska delar från payload
    el.title.textContent = d.title || "Okänd låt";
    el.artist.textContent = (d.artists||[]).join(", ") || d.album || "";
    if(d.image){
      el.cover.src = d.image;
      el.bg.style.backgroundImage = `url("${d.image}")`;
      dominantColorFromURL(d.image).then(setAccent);
    }
    el.card.href = d.url || "#";
    el.by.textContent = who ? `av ${who}` : "";
  }

  // === Ticking (rAF + setInterval resync) ===
  // rAF för jämn animation, setInterval för regelbunden uppdatering. :contentReference[oaicite:1]{index=1}
  let rafId=null, tickId=null, syncId=null, hideTimer=null;
  let baseProgress=0, duration=1, startedAt=0; // ms

  function startTicker(p0, dur){
    baseProgress = p0|0;
    duration     = Math.max(1, dur|0);
    startedAt    = performance.now();

    stopTicker(); // ifall en fanns
    const step = (t)=>{
      const elapsed = t - startedAt;
      const p = Math.min(duration, baseProgress + elapsed);
      el.tStart.textContent = ms(p);
      el.tEnd.textContent   = ms(duration);
      el.bar.style.width    = (100 * p / duration) + "%";
      rafId = requestAnimationFrame(step); // rAF – körs före nästa repaint. :contentReference[oaicite:2]{index=2}
    };
    rafId = requestAnimationFrame(step);

    // Extra säkerhets-tick (minst var TICK_MS) – om du vill strikt 1 Hz kan du sätta ?tick=1000
    tickId = setInterval(()=>{
      // uppdateringen görs redan via rAF; intervallet finns bara för att garantera "minst X ms"
      // här kan vi tvinga en uppdatering om rAF skulle pausas
      const now = performance.now();
      const p = Math.min(duration, baseProgress + (now - startedAt));
      el.tStart.textContent = ms(p);
      el.bar.style.width    = (100 * p / duration) + "%";
    }, TICK_MS); // setInterval kör vår funktion upprepat tills clearInterval(). :contentReference[oaicite:3]{index=3}

    // Resync mot servern för att undvika drift
    syncId = setInterval(async ()=>{
      try{
        const r = await fetch(API_NOW,{cache:"no-store"});
        const j = await r.json();
        if (j && j.playing && j.id) {
          // Om låten bytts under visningen: avsluta visningen direkt (valfritt)
          // annars justera progress så animationen matchar servern
          baseProgress = j.progress_ms|0;
          duration     = Math.max(1, j.duration_ms|0);
          startedAt    = performance.now();
        }
      }catch{}
    }, SYNC_MS);
  }
  function stopTicker(){
    if(rafId!==null){ cancelAnimationFrame(rafId); rafId=null; }
    if(tickId){ clearInterval(tickId); tickId=null; }
    if(syncId){ clearInterval(syncId); syncId=null; }
  }

  function showFor(ms){
    clearTimeout(hideTimer);
    el.tray.classList.add("show");
    hideTimer = setTimeout(()=>{
      el.tray.classList.remove("show");
      stopTicker();
    }, ms);
  }

  // === Dataflöde ===
  async function fetchNowWithRetry(max=5, delay=250){
    for(let i=0;i<max;i++){
      try{ const r=await fetch(API_NOW,{cache:"no-store"}); const j=await r.json(); if(j&&j.playing) return j; }catch{}
      await new Promise(r=>setTimeout(r,delay));
    }
    try{ const s=await fetch(API_SNAP,{cache:"no-store"}); const j=await s.json(); if(j&&j.playing) return j; }catch{}
    return {playing:false};
  }

  async function handleTrigger(who){
    const now = await fetchNowWithRetry(6, 250);
    if(!now || !now.playing) return;

    paintStatic(now, who);
    startTicker(now.progress_ms||0, now.duration_ms||1);
    showFor(DUR_MS);
  }

  // SSE: triggas från servern när någon skriver !song/!låt
  // EventSource håller en långlivad anslutning och tar emot events från servern. :contentReference[oaicite:4]{index=4}
  const es = new EventSource("/events");
  es.addEventListener("song", (ev)=>{
    let by=null; try{ by=JSON.parse(ev.data).by||null; }catch{}
    handleTrigger(by);
  });

  // Snabbtest i browsern: tryck S
  addEventListener("keydown",(e)=>{ if(e.key.toLowerCase()==="s") handleTrigger("debug"); });
</script>
</body>
</html>
